<div class="container">
  @if (laudo$ | async; as laudo) {
    @if(laudo) {
      <header class="page-header">
        <div class="header-info">
          <h1 class="mat-headline-5 mb-0">Laudo Pericial</h1>
          <span class="processo-badge">{{ laudo.identificacaoProcesso?.PROCESSO_NUM }}</span>
        </div>
        <div class="actions">
          <button mat-button (click)="goBack()">
            <mat-icon>arrow_back</mat-icon> Voltar
          </button>
          <button mat-stroked-button (click)="copyJsonToClipboard()">
            <mat-icon>content_copy</mat-icon> JSON
          </button>
          <button mat-flat-button color="primary" (click)="copyPromptToClipboard()">
            <mat-icon>smart_toy</mat-icon> Prompt AI
          </button>
        </div>
      </header>

      <div class="grid-2-col">
        <mat-card class="info-card">
          <mat-card-header>
            <mat-icon mat-card-avatar class="avatar-icon">person</mat-icon>
            <mat-card-title>Periciando(a)</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="data-row">
              <div class="data-item">
                <label>Nome</label>
                <p><strong>{{ laudo.identificacaoProcesso?.NOME_PERICIANDO }}</strong></p>
              </div>
              <div class="data-item">
                <label>Idade / Nasc.</label>
                <p>{{ laudo.dadosPericiando?.DATA_NASCIMENTO }}</p>
              </div>
            </div>
            <div class="data-row">
              <div class="data-item">
                <label>Escolaridade</label>
                <p>{{ laudo.dadosPericiando?.ESCOLARIDADE }}</p>
              </div>
               <div class="data-item">
                <label>Estado Civil</label>
                <p>{{ laudo.dadosPericiando?.ESTADO_CIVIL }}</p>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <mat-card class="info-card">
          <mat-card-header>
             <mat-icon mat-card-avatar class="avatar-icon">gavel</mat-icon>
             <mat-card-title>Dados do Processo</mat-card-title>
          </mat-card-header>
          <mat-card-content>
             <div class="data-item full-width">
                <label>Juízo</label>
                <p>{{ laudo.identificacaoProcesso?.JUIZO }}</p>
             </div>
             <div class="data-item">
                <label>Data do Exame</label>
                <p>{{ laudo.identificacaoProcesso?.DATA_EXAME }}</p>
             </div>
          </mat-card-content>
        </mat-card>
      </div>

      <mat-card class="medical-section">
        <mat-card-header>
          <mat-card-title>Avaliação Médica</mat-card-title>
        </mat-card-header>
        <mat-card-content class="no-padding">
          <mat-tab-group mat-stretch-tabs="false" animationDuration="0ms">
            
            <mat-tab>
              <ng-template mat-tab-label>
                <mat-icon class="tab-icon">history_edu</mat-icon> História Clínica
              </ng-template>
              <div class="tab-content">
                <markdown [data]="laudo.dadosMedicos?.HISTORIA_CLINICA"></markdown>
              </div>
            </mat-tab>

            <mat-tab>
              <ng-template mat-tab-label>
                <mat-icon class="tab-icon">radiology</mat-icon> Exames Complementares
              </ng-template>
              <div class="tab-content bg-light">
                @if(laudo.dadosMedicos?.EXAMES) {
                  <markdown [data]="laudo.dadosMedicos?.EXAMES"></markdown>
                } @else {
                  <p class="text-muted">Nenhum exame registrado.</p>
                }
              </div>
            </mat-tab>

            <mat-tab>
              <ng-template mat-tab-label>
                <mat-icon class="tab-icon">medical_services</mat-icon> Exame Físico
              </ng-template>
              <div class="tab-content">
                 @if(laudo.dadosMedicos?.EXAME_CLINICO) {
                  <markdown [data]="laudo.dadosMedicos?.EXAME_CLINICO"></markdown>
                } @else {
                  <p class="text-muted">Exame físico não detalhado.</p>
                }
              </div>
            </mat-tab>

          </mat-tab-group>
        </mat-card-content>
      </mat-card>

      <mat-expansion-panel expanded="true" class="mb-4">
        <mat-expansion-panel-header>
          <mat-panel-title class="section-title">
            <mat-icon>work</mat-icon> Histórico Laboral e Profissiografia
          </mat-panel-title>
        </mat-expansion-panel-header>

        <div class="laboral-content">
          <div class="info-grid-compact">
             <div class="data-item">
                <label>Função Declarada</label>
                <p><strong>{{ laudo.historicoLaboral?.FUNCAO_HABITUAL_ATUAL?.descricao }}</strong></p>
             </div>
             <div class="data-item">
                <label>Tempo Total</label>
                <p>{{ laudo.historicoLaboral?.TEMPO_TOTAL_ATIVIDADE }}</p>
             </div>
             <div class="data-item">
                <label>Afastamento</label>
                <p>{{ laudo.historicoLaboral?.DATA_AFASTAMENTO_DECLARADA }}</p>
             </div>
          </div>

          <mat-divider class="my-3"></mat-divider>
          
          <h3 class="subsection-title">Narrativa Ocupacional</h3>
          <markdown [data]="laudo.historicoLaboral?.HISTORICO_OCUPACIONAL_COMPLETO"></markdown>

          @if(laudo.historicoLaboral?.PROFISSIOGRAFIA; as prof) {
            <div class="profissiografia-box">
              <h4>Análise da Atividade: {{ prof.atividade_analisada }}</h4>
              
              <div class="prof-grid">
                <div>
                  <strong>Tarefas Executadas:</strong>
                  <ul>
                    @for(tarefa of prof.tarefas_executadas; track tarefa) {
                      <li>{{ tarefa }}</li>
                    }
                  </ul>
                </div>
                <div>
                   <p><strong>Postura:</strong> {{ prof.postura_corporal }}</p>
                   <p><strong>Carga:</strong> {{ prof.carga_fisica }}</p>
                   <p><strong>Exigências:</strong> {{ prof.exigencias_fisicas }}</p>
                </div>
              </div>
            </div>
          }
        </div>
      </mat-expansion-panel>

      <mat-expansion-panel class="mb-4">
        <mat-expansion-panel-header>
          <mat-panel-title class="section-title">
            <mat-icon>gavel</mat-icon> Análise com Diretrizes
          </mat-panel-title>
          <mat-panel-description>
            Selecione normas para fundamentar a análise
          </mat-panel-description>
        </mat-expansion-panel-header>

        <div class="diretrizes-container">
          
          <div class="filter-section">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>Esfera Judicial</mat-label>
              <mat-select [ngModel]="filtroJustica()" (ngModelChange)="filtroJustica.set($event)">
                <mat-option value="Justiça Federal">Justiça Federal</mat-option>
                <mat-option value="Justiça do Trabalho">Justiça do Trabalho</mat-option>
                <mat-option value="Justiça Comum">Justiça Comum</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <div class="list-section">
            <p class="list-label">Selecione as diretrizes aplicáveis:</p>
            <mat-selection-list #diretrizesList (selectionChange)="atualizarDiretrizes(diretrizesList.selectedOptions.selected)">
              @for (diretriz of diretrizesFiltradas(); track diretriz.id) {
                <mat-list-option [value]="diretriz" color="primary">
                  <span matListItemTitle>{{ diretriz.nome }}</span>
                  <span matListItemLine class="text-small">Link: {{ diretriz.link | slice:0:30 }}...</span>
                </mat-list-option>
              } @empty {
                <div class="empty-list">
                  <p>Nenhuma diretriz encontrada para esta esfera.</p>
                </div>
              }
            </mat-selection-list>
          </div>

          <div class="action-section">
            <button mat-flat-button color="accent" 
                    (click)="analisarComIA()" 
                    [disabled]="isAnalisando() || diretrizesSelecionadas().length === 0">
              @if(isAnalisando()) {
                <mat-icon><mat-spinner diameter="18"></mat-spinner></mat-icon>
                Analisando...
              } @else {
                <mat-icon>psychology</mat-icon>
                Analisar com IA
              }
            </button>
          </div>

          @if (resultadoAnaliseIA()) {
            <mat-divider class="my-4"></mat-divider>
            <div class="ai-result-box">
              <h3><mat-icon class="ai-icon">auto_awesome</mat-icon> Sugestão da IA</h3>
              <markdown [data]="resultadoAnaliseIA()"></markdown>
            </div>
          }

        </div>
      </mat-expansion-panel>

      <mat-expansion-panel>
        <mat-expansion-panel-header>
          <mat-panel-title class="section-title">
            <mat-icon>assignment</mat-icon> Observações e Conclusão
          </mat-panel-title>
        </mat-expansion-panel-header>
        
        <div class="obs-content">
          <markdown [data]="laudo.OBSERVACOES"></markdown>
        </div>
      </mat-expansion-panel>
      
      @if(objectKeys(laudo.respostasQuesitos).length > 0) {
        <mat-expansion-panel class="mt-3">
          <mat-expansion-panel-header>
            <mat-panel-title class="section-title">
              <mat-icon>question_answer</mat-icon> Quesitos
            </mat-panel-title>
          </mat-expansion-panel-header>
          <div class="quesitos-list">
            @for (quesito of objectKeys(laudo.respostasQuesitos); track quesito) {
              <div class="quesito-item">
                <strong class="q-label">{{ quesito }}</strong>
                <p class="q-answer">{{ laudo.respostasQuesitos[quesito] }}</p>
              </div>
            }
          </div>
        </mat-expansion-panel>
      }

      <footer class="doc-footer">
        <p>Laudo emitido eletronicamente em {{ laudo.dadosLaudo?.DIA_LAUDO }}/{{ laudo.dadosLaudo?.MES_LAUDO }}/{{ laudo.dadosLaudo?.ANO_LAUDO }}</p>
      </footer>

    } @else {
      <div class="empty-state">
        <mat-icon>folder_off</mat-icon>
        <p>Nenhum laudo encontrado para este processo.</p>
      </div>
    }
  } @else {
    <mat-progress-bar mode="indeterminate"></mat-progress-bar>
  }
</div>